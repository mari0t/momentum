name: Build iOS App

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    name: Build Standalone iOS App
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ— Setup repo
        uses: actions/checkout@v3

      - name: ğŸ— Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 18.x
          cache: npm

      - name: ğŸ— Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸš€ Build standalone iOS app
        run: eas build --platform ios --profile github --non-interactive

      - name: ğŸ“± Get build artifact
        id: build
        run: |
          BUILD_URL=$(eas build:list --platform=ios --status=finished --limit=1 --json | jq -r '.[0].artifacts.buildUrl')
          echo "build_url=$BUILD_URL" >> $GITHUB_OUTPUT
          curl -L -o momentum.ipa "$BUILD_URL"

      - name: ğŸ“¦ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          name: ğŸ“± Momentum iOS App v${{ github.run_number }}
          body: |
            ğŸš€ **Momentum Productivity App - iOS Release**
            
            ## ğŸ“± Installation Methods:
            
            ### ğŸ´â€â˜ ï¸ TrollStore (Permanent - iOS 14-16.6.1)
            - Download the `momentum.ipa` file below
            - Open in TrollStore â†’ Tap "Install"
            - **Permanent installation - works forever!**
            
            ### âš¡ AltStore (7-day refresh)  
            - Download the `momentum.ipa` file below
            - Install via AltStore
            - Refresh weekly via AltStore
            
            ### ğŸ“± Sideloadly (Computer needed)
            - Download the `momentum.ipa` file below  
            - Use Sideloadly to install on your device
            
            ## âœ¨ App Features:
            - ğŸ§  **Smart Focus Sessions** with brain shortcuts
            - ğŸ“¸ **Camera Food Scanning** for nutrition tracking
            - ğŸŒ **Full Translations** (Polish/English)
            - ğŸ“± **Mobile-Optimized** navigation and design
            - ğŸ¯ **Task Management** & productivity tracking
            - ğŸŒ™ **Dark Theme** optimized for iOS
            
            ## ğŸ“‹ Installation Instructions:
            1. Download the `.ipa` file below
            2. Choose your installation method above
            3. Follow the specific instructions for your method
            4. Enjoy your standalone iOS app!
            
            ---
            **Built with â¤ï¸ using Expo & React**
          files: momentum.ipa
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
