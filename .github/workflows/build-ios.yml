name: Build iOS App for EU Distribution

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  build:
    name: Build iOS App
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ— Setup repo
        uses: actions/checkout@v4

      - name: ğŸ— Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: npm

      - name: ğŸ— Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: ğŸ“¦ Install dependencies
        run: |
          npm ci --legacy-peer-deps
          npx expo install --fix

      - name: ğŸ” Check EAS login
        run: |
          echo "Checking EAS authentication..."
          eas whoami || echo "EAS login required"

      - name: ğŸš€ Build iOS app
        run: |
          echo "ğŸ”„ Starting iOS build..."
          echo "ğŸ“± Project ID: ${{ secrets.EXPO_PROJECT_ID || 'ff5ea975-f6a5-49b1-9480-1a7a1d086fb6' }}"
          
          # Try build with error handling
          if eas build --platform ios --profile standalone --non-interactive --wait; then
            echo "âœ… Build successful!"
            echo "ğŸ”— Download from: https://expo.dev/accounts/mari0u/projects/momentum-productivity-app/builds"
          else
            echo "âŒ Build failed. Common solutions:"
            echo "1. Check EXPO_TOKEN secret is set correctly"
            echo "2. Verify EAS project configuration"
            echo "3. Check build logs at: https://expo.dev/accounts/mari0u/projects/momentum-productivity-app/builds"
            echo "4. Try manual build: eas build --platform ios --profile standalone"
            exit 1
          fi

      - name: ğŸ“± Success message
        if: success()
        run: |
          echo "ğŸ‰ iOS build completed successfully!"
          echo ""
          echo "ğŸ“± Next steps:"
          echo "1. Go to: https://expo.dev/accounts/mari0u/projects/momentum-productivity-app/builds"
          echo "2. Download the .ipa file"
          echo "3. Install on iPhone via Safari (EU direct install)"
          echo "4. Share with friends using: https://mari0t.github.io/momentum/"
