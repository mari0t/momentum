name: Build Pure React Native iOS App

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - 'MomentumPure/**'

jobs:
  build-ios:
    name: Build Pure iOS App
    runs-on: macos-latest
    
    steps:
      - name: ðŸ— Setup repo
        uses: actions/checkout@v4

      - name: ðŸ— Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: npm
          cache-dependency-path: MomentumPure/package-lock.json

      - name: ðŸŽ Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: ðŸ’Ž Setup Ruby and CocoaPods
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.0'
          bundler-cache: true
          working-directory: MomentumPure

      - name: ðŸ“¦ Install Node dependencies
        working-directory: MomentumPure
        run: |
          npm ci
          echo "âœ… Node dependencies installed"

      - name: ðŸ”§ Install CocoaPods dependencies
        working-directory: MomentumPure/ios
        run: |
          gem install cocoapods
          pod install --repo-update
          echo "âœ… CocoaPods dependencies installed"

      - name: ðŸ”¨ Build iOS App
        working-directory: MomentumPure
        run: |
          # Build the iOS app using React Native CLI
          npx react-native run-ios --configuration Release --device
          
          echo "ðŸŽ‰ iOS build completed!"

      - name: ðŸ“¦ Archive and Export IPA
        working-directory: MomentumPure/ios
        run: |
          # Create archive
          xcodebuild -workspace MomentumPure.xcworkspace \
            -scheme MomentumPure \
            -configuration Release \
            -destination generic/platform=iOS \
            -archivePath MomentumPure.xcarchive \
            archive
          
          # Create export options
          cat > ExportOptions.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>ad-hoc</string>
              <key>uploadBitcode</key>
              <false/>
              <key>uploadSymbols</key>
              <false/>
              <key>compileBitcode</key>
              <false/>
              <key>signingStyle</key>
              <string>automatic</string>
          </dict>
          </plist>
          EOF
          
          # Export IPA
          xcodebuild -exportArchive \
            -archivePath MomentumPure.xcarchive \
            -exportPath . \
            -exportOptionsPlist ExportOptions.plist
          
          echo "ðŸ“± IPA exported successfully!"

      - name: ðŸ“± Upload IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: momentum-pure-ios-app
          path: MomentumPure/ios/*.ipa
          retention-days: 30

      - name: ðŸŽ¯ Build Success
        run: |
          echo "ðŸŽ‰ PURE REACT NATIVE iOS APP BUILT SUCCESSFULLY!"
          echo ""
          echo "ðŸ“± How to install:"
          echo "1. Go to Actions tab in GitHub"
          echo "2. Download 'momentum-pure-ios-app' artifact"
          echo "3. Extract the .ipa file"
          echo "4. Install on iPhone via Safari (EU) or AltStore"
          echo ""
          echo "ðŸ”— GitHub Actions: https://github.com/${{ github.repository }}/actions"
